# 05.渲染中光和材质的数学魔法

***光、材质与着色器***

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled.png)

这节课会有很多繁杂的数学公式，但不必深究，可以当作一个故事来听。

![渲染器宗师，一切的渲染都可以通过这个六维方程阐述](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%201.png)

渲染器宗师，一切的渲染都可以通过这个六维方程阐述

![$cos\theta$  ：不同的入射角影响光强     举例：同样的太阳光线角度，为何地球两极冷，赤道热](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%202.png)

$cos\theta$  ：不同的入射角影响光强     举例：同样的太阳光线角度，为何地球两极冷，赤道热

![看似简单，但真实世界的光线极为复杂  举例：反射面如果带颜色，那么这个颜色还可以反射出去成为一个新的光源……半透明、Gloss……](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%203.png)

看似简单，但真实世界的光线极为复杂  举例：反射面如果带颜色，那么这个颜色还可以反射出去成为一个新的光源……半透明、Gloss……

- 渲染中极难的几个挑战
    
    ![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%204.png)
    
    - 光线可见性（阴影Shadow） “Shadow is bitch”
        
        ![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%205.png)
        
    - 光源的复杂性
        
        ![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%206.png)
        
        点光源、锥形光、方向光源都很简单，但**面光源**极为复杂
        
    - 实时Runtime的对光线与模型进行高效的积分计算
        
        ![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%207.png)
        
    - 所有物质都是光源
        
        ![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%208.png)
        
        当任何物质都是光源时又会让问题一变得极为复杂
        
        著名的RayTracing算法其中一个方法就是一个ray打出去后不停的发散，最后就会爆掉（现在不再这么写了）。
        
    

---

# 让我们从简开始

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%209.png)

![最简单的光源形态](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2010.png)

最简单的光源形态

![环境贴图（六边形的cubemap）](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2011.png)

环境贴图（六边形的cubemap）

![Blinn-Phong模型](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2012.png)

Blinn-Phong模型

体现了光可叠加原理，无论光来自于哪里，都可以线性叠加起来。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2013.png)

Blinn-Phong模型的问题：光的能量是不守恒的，光线的出射能量可能超过1.

左图这个圆球，如果有光漏进去之后，里面不停的反弹会让内部变亮。

Blinn-Phong很简单，但是和真实世界的关系没有那么大，当想表达真实世界中各种各样的问题的时候无论怎么调看上去都很塑料。PBR材质就可以把各种金属、非金属、塑料……材质表达到位。

![光是否可见](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2014.png)

光是否可见

![图形学中计算Shadow有各种各样的方式，但在游戏中，我们只信ShadowMap](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2015.png)

图形学中计算Shadow有各种各样的方式，但在游戏中，我们只信ShadowMap

ShadowMap：从光的视角渲染一个场景，不需要任何数据，只需要告诉我深度，深度表示光到某点的距离。从投影区域计算反射到物体上的距离，如果这段距离大于光源到遮挡物的距离的话，那就在Shadow中了。

![ShadowMap的问题：精细度受到采样率的限制](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2016.png)

ShadowMap的问题：精细度受到采样率的限制

---

# 基于预计算的全局光照（GI）

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2017.png)

场景中百分之九十的物件都是不动的，那么我们就可以通过预计算来提前计算好各种光照。

***空间换时间***

![只算直接光照（左），几乎感受不到光照，很平面](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2018.png)

只算直接光照（左），几乎感受不到光照，很平面

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2019.png)

但是全局光照所需要的数据量特别大，如果屏幕上看到的每个像素都要去做这个运算那就会疯掉。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2020.png)

解决办法：傅里叶变换，能够把一个信号，分解成几个不同信号频率的累加。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2021.png)

一张照片，可以变成傅里叶变换的频率谱，从空间域变成频域，如果只截取频域中的一小段，实际就已经完成了对信号的一个粗糙的表达。

![球面调和函数](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2022.png)

球面调和函数

![绿色是正值，红色是负值](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2023.png)

绿色是正值，红色是负值

这些所有的无限维的函数，都是正交的。

![很多复杂的信息都可以通过这个函数近似表达](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2024.png)

很多复杂的信息都可以通过这个函数近似表达

![这种压缩在低频十分有用，原本场景反射球捕捉许多信息，可以通过该函数，压缩到**四个**值就足够表达环境光，因为环境光是低频的。](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2025.png)

这种压缩在低频十分有用，原本场景反射球捕捉许多信息，可以通过该函数，压缩到**四个**值就足够表达环境光，因为环境光是低频的。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2026.png)

二阶或三阶的球面调和函数都可以转换成简单的向量运算

存一个在点上的光场，通过这种压缩，在计算机上只需要32bit就能够表达一个色彩信息（RGBA）。并且每一层信息的权重是不同的

## 第一种算法：空间换时间，预计算全局光

![基于此思想，就能做这件疯狂的事，**预烘焙全局光照**](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2027.png)

基于此思想，就能做这件疯狂的事，**预烘焙全局光照**

![首先要使用低模：不浪费UV，就能不浪费光照贴图](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2028.png)

首先要使用低模：不浪费UV，就能不浪费光照贴图

![烘焙光照](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2029.png)

烘焙光照

![直接光照+预计算光照+高模](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2030.png)

直接光照+预计算光照+高模

![直接光照+预计算光照+高模+材质](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2031.png)

直接光照+预计算光照+高模+材质

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2032.png)

*优点：实时计算很快；烘培了很多优秀的环境光照细节*

*缺点：预计算时间很长；只能处理静态物体和静态光；需要大量GPU存储成本（空间换时间，几十Mb到上百Mb）*

---

## 第二种算法：游戏空间中的探针

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2033.png)

游戏场景中都Scatter无数个Probe，物体到其中一个Probe位置时，采样周围的Probe做插值来计算光照。（空间体素化）

![Houdini程序化摆放Probe](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2034.png)

Houdini程序化摆放Probe

摆放Probe是一个非常麻烦的事，曾经需要手动点，现如今可以通过算法程序化的方法自动摆放。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2035.png)

游戏中的反射捕获大多数是非常低频的，可以运用之前的压缩算法压倒四个值，但是游戏中会有少部分环境需要非常高亮得反射，反射对高频很敏感，所以需要很高的精度。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2036.png)

*优点：实时运算快；能同时结合静态和动态物体；同时处理漫反射和镜面反射。*

*缺点：因为能对动的物体处理，所以不能实现高质量的预计算光照阴影，比如那种柔和的阴影边缘；光照探针也需要预计算。*

---

# 基于物理的材质Physical-Based Material

![微平面理论](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2037.png)

微平面理论

用一套假设解决了一系列光学现象：认为一个表面就是无数的反射，金属表面粗糙和光滑与否决定于法向都集中一个方向就很光滑，像镜子；如果分散的开，就看上去就比较糊。

![基于微表面的BRDF模型](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2038.png)

基于微表面的BRDF模型

- 光打到物体表面无非发生两种事情
    1. 把光反弹回去，能弹回去多少取决于物体表面的法向分布，也就是Roughness的粗糙度。
    2. 一部分光会射进物体内部，如果是金属，内部的电子就有能力把这些光子给吸收了；如果是非金属，电子就没有能力捕获这些光子，会在内部弹几下然后以一个随机的方向射出去。这就是**Diffuse**
- PBR模型的材质就是两部分：
    
    漫反射，$\frac{C}{PI}$       $C$就是有多少能量进入
    
    反射， $DFG$
    

## $D$  法线分布函数 normal distribution function

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2039.png)

GGX模型函数图像（左下角绿色）高频很尖锐，低频缓和（举例：音响高音脆，低音沉就是个好音响）。表达高光足够尖锐，想要低频表达时也不会彻底消失（Phong模型Power的高光数值很高时就很生硬）。

Roughness在其中表达了法相分布的随机度，Roughness越高随机性越强。

## $G$  几何自衰减（自阴影）shadowing-masking function

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2040.png)

每个表面凹凸不平，光可能会被自身挡住。基于GGX理论，先算一遍模型和视线的阻挡关系，再算一遍模型和入射光的阻挡关系

# $F$ 菲涅尔现象

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2041.png)

当视线角度越靠近物体切线方向的时候，反射系数就会急剧增加，就会产生更强的倒影效果。

*大神们推导出的0~5次方*

![BRDF测量](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2042.png)

BRDF测量

通过不同的光线和摄像机角度测量BRDF。

### **迪斯尼BRDF信条**

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2043.png)

- **信条**
    
    **每一个参数都要符合艺术家的直觉；**
    
    **应该尽可能的减少可调参数；**
    
    **参数值的范围最好是0~1；**
    
    **再合理情况下，允许参数超过范围；**
    
    **所有参数的组合抖尽可能有意义。**
    

引擎不是一个自然界模拟器，而是工具，把快乐留给设计师。

![迪斯尼主要材质参数](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2044.png)

迪斯尼主要材质参数

## PBR Specular Glossiness模型

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2045.png)

**几乎没有参数，所有参数都用图形表达。**

![注意归一化](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2046.png)

注意归一化

优点：不需要数值控制，设计师可以绘图进行精准的像素级控制。

缺点：过于灵活，特别是Specalur的RBG通道，设计师一旦设置不好，菲涅尔那一项就容易炸掉。

## PBR Metallic Roughness模型

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2047.png)

只允许设计师设置一个叫Metallic（金属度）的值。

如果金属度低，就是非金属，所以不能进入菲涅尔那一项去计算；如果是金属，就会大量参与菲涅尔计算。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2048.png)

因为SG模型灵活度太高，参数过多，所以MR模型就是在SG模型外面包了一层，防止设计师用错（小白用户指南）。

虽然艺术家灵活度下降了，但不容易出问题。

![MR和SG的优缺点](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2049.png)

MR和SG的优缺点

MR模型仔细观看有一个白边，难以消除。设计师更喜欢MR模型，更符合直觉。

---

# 基于图像的光照Image-Based Lighting(IBL)

![IBL的核心想法](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2050.png)

IBL的核心想法

如果对环境光照进行一些预处理，就能很快地计算出来。

![再次回忆BRDF方程，看上去很复杂其实就两部分，Diffuse和Specular](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2051.png)

再次回忆BRDF方程，看上去很复杂其实就两部分，Diffuse和Specular

![Diffuse部分](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2052.png)

Diffuse部分

提前计算好Irradiance Map（光线散射贴图）把所有角度的卷积结果计算好，在游戏引擎中上百万上千万的像素需要至少每秒30帧的计算是非常复杂的，预计算好卷积之后只需要查表就能找到正确的结果。

![Specular部分](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2053.png)

Specular部分

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2054.png)

核心想法：同样是预计算好卷积的结果，但是不同Roughness计算的Specalur结果不同，于是运用了硬件上CubeMap中MipMap的功能，把不同的结果存到了不同的层级。同样是个速算表，Roughness从0~1的时候结果提前算好，要使用时直接去里面查。

粗糙度越高，对光照的敏感度越低，使用越低级的Mip，符合视觉直觉。

![LookUpTable（本质上同样是个速算表）](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2055.png)

LookUpTable（本质上同样是个速算表）

LookUpTable有两个维度：Roughness和$cos\theta$

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2056.png)

**光照=预计算光照辐射度贴图+预计算CubeMap的Mip $\cdot$ Roughness和$cos\theta$**

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2057.png)

---

# 经典阴影解决方法

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2058.png)

![Cascade Shadow（联机阴影）](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2059.png)

Cascade Shadow（联机阴影）

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2060.png)

通过把视锥分成几层，从摄像机开始把近处Shadow设置密度高，远处低，同时符合进大远小。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2061.png)

缺点：需要做插值，不然某些地方会很生硬。

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2062.png)

优点：解决Shadow常见问题“透视走样”最好的方法；

拥有3倍的解决速度，计算非常快；

拥有非常棒的结果。

缺点：几乎不可能产生高质量的区域阴影；

阴影没有颜色，无法在半透明表面上产生不透明阴影。

![硬Shadow和软Shadow](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2063.png)

硬Shadow和软Shadow

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2064.png)

用滤波的方法告诉你怎么去做软阴影

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2065.png)

PCSS基于场景深度计算阴影，采用平面近似的方法

![方差软阴影图Variance Soft Shadow Map](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2066.png)

方差软阴影图Variance Soft Shadow Map

用切克夫不等式，计算实时真实阴影

![Untitled](05%20%E6%B8%B2%E6%9F%93%E4%B8%AD%E5%85%89%E5%92%8C%E6%9D%90%E8%B4%A8%E7%9A%84%E6%95%B0%E5%AD%A6%E9%AD%94%E6%B3%95/Untitled%2067.png)